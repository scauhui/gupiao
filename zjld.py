import json
import requests
from requests.exceptions import RequestException
from pymongo import MongoClient


client = MongoClient()  ##连接数据库
db = client['hmt']  #指定数据库
collection = db['zjld'] #声明对象


def get_one_page(url):
	headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.100 Safari/537.36'
        }
	response = requests.get(url, headers=headers)
	try:
		response = requests.get(url, headers=headers)
		if response.status_code == 200:  # 响应码
			#print(response.json().get('gdrs'))
			return response.text
	except requests.ConnectionError as e:
		print('Error', e.args)

def parse_page(json):
	response = [
		"2019-02-12,89239.0016,14.74%,91492.0304,15.11%,-2253.0288,-0.37%,-33504.2,-5.53%,-55734.8,-9.2%,2.98,9.96%",
		"2019-02-13,31741.4192,6.85%,32987.5552,7.12%,-1246.136,-0.27%,-11500.3584,-2.48%,-20241.0624,-4.37%,3.28,10.07%",
		"2019-02-14,-39991.712,-2.96%,-33686.968,-2.49%,-6304.744,-0.47%,890.312,0.07%,39101.4,2.9%,3.50,6.71%",
		"2019-02-15,-670.1856,-0.07%,-16428.8848,-1.77%,15758.6992,1.7%,1546.1696,0.17%,-875.9856,-0.09%,3.55,1.43%",
		"2019-02-18,-71065.0144,-6.09%,-85930.2432,-7.36%,14865.2288,1.27%,23508.7584,2.01%,47556.2576,4.07%,3.75,5.63%",
		"2019-02-19,-66964.3808,-7.75%,-58166.7088,-6.73%,-8797.672,-1.02%,18709.2512,2.16%,48255.1312,5.58%,3.73,-0.53%",
		"2019-02-20,2195.1232,0.25%,6401.9168,0.74%,-4206.7936,-0.49%,-9096.0944,-1.05%,6900.9712,0.8%,3.80,1.88%",
		"2019-02-21,-50857.8048,-6.59%,-44078.5696,-5.71%,-6779.2352,-0.88%,11081.0624,1.44%,39776.7424,5.15%,3.72,-2.11%",
		"2019-02-22,18886.016,3.23%,25692.1664,4.4%,-6806.1504,-1.17%,-13083.7952,-2.24%,-5802.2208,-0.99%,3.78,1.61%",
		"2019-02-25,133670.456,13.82%,193277.0432,19.98%,-59606.5872,-6.16%,-74531.9792,-7.71%,-59138.4832,-6.11%,4.16,10.05%",
		"2019-02-26,-65372.8256,-3.77%,-87195.5712,-5.03%,21822.7456,1.26%,28577.8624,1.65%,36794.9552,2.12%,4.37,5.05%",
		"2019-02-27,-193295.9152,-15.79%,-199299.0736,-16.28%,6003.1584,0.49%,73189.7328,5.98%,120106.1904,9.81%,4.11,-5.95%",
		"2019-02-28,-119233.592,-16.83%,-125534.0336,-17.72%,6300.4416,0.89%,47014.552,6.64%,72219.04,10.2%,4.04,-1.70%",
		"2019-03-01,-4160.36,-0.55%,-12409.0032,-1.63%,8248.6432,1.08%,-2315.9936,-0.3%,6476.3536,0.85%,4.25,5.20%",
		"2019-03-04,-94935.6992,-9.3%,-68497.9728,-6.71%,-26437.7264,-2.59%,34350.8528,3.36%,60584.8464,5.93%,4.29,0.94%",
		"2019-03-05,18852.6336,2.36%,39534.1744,4.95%,-20681.5408,-2.59%,-18562.1536,-2.32%,-290.4816,-0.04%,4.39,2.33%",
		"2019-03-06,-195805.1232,-15.56%,-176503.8064,-14.03%,-19301.3168,-1.53%,72921.2192,5.8%,122883.9024,9.77%,4.27,-2.73%",
		"2019-03-07,-39788.456,-4.74%,-30636.3472,-3.65%,-9152.1088,-1.09%,9545.144,1.14%,30243.312,3.6%,4.17,-2.34%",
		"2019-03-08,-32280.9168,-4.13%,-24434.4144,-3.12%,-7846.5024,-1%,7081.5744,0.91%,25199.3408,3.22%,3.99,-4.32%",
		"2019-03-11,-18077.1376,-2.5%,-2816.0032,-0.39%,-15261.1344,-2.11%,4514.6816,0.62%,13562.4576,1.87%,4.11,3.01%",
		"2019-03-12,-41642.4592,-6.62%,-31198.5904,-4.96%,-10443.8688,-1.66%,12445.7824,1.98%,29196.6784,4.64%,4.09,-0.49%",
		"2019-03-13,-124785.7168,-21.86%,-119492.2944,-20.93%,-5293.4224,-0.93%,36306.1808,6.36%,88479.536,15.5%,3.90,-4.65%",
		"2019-03-14,-55801.1504,-12.45%,-47773.5776,-10.66%,-8027.5728,-1.79%,5402.0624,1.21%,50399.088,11.24%,3.78,-3.08%",
		"2019-03-15,-38417.5184,-12.62%,-35340.9216,-11.61%,-3076.5968,-1.01%,7956.28,2.61%,30461.2384,10%,3.79,0.26%",
		"2019-03-18,-21627.264,-5.24%,-31486.8352,-7.64%,9859.5712,2.39%,7802.432,1.89%,13824.832,3.35%,3.84,1.32%",
		"2019-03-19,-21127.0336,-4.32%,-9683.2304,-1.98%,-11443.8032,-2.34%,10784.0624,2.21%,10342.9712,2.12%,3.92,2.08%",
		"2019-03-20,-46986.976,-15.77%,-36864.5456,-12.37%,-10122.4304,-3.4%,8177.6928,2.74%,38809.2848,13.03%,3.88,-1.02%",
		"2019-03-21,8445.7008,2.25%,19650.0448,5.23%,-11204.344,-2.98%,-10397.2288,-2.77%,1951.528,0.52%,3.90,0.52%",
		"2019-03-22,28546.8432,4.63%,30477.5392,4.95%,-1930.696,-0.31%,-15449.4512,-2.51%,-13097.3904,-2.13%,4.04,3.59%",
		"2019-03-25,-44123.9072,-7.59%,-36343.4128,-6.25%,-7780.4944,-1.34%,16038.6448,2.76%,28085.2624,4.83%,4.02,-0.50%",
		"2019-03-26,-100186.464,-20.9%,-67174.9904,-14.01%,-33011.4736,-6.89%,19284.7744,4.02%,80901.688,16.87%,3.82,-4.98%",
		"2019-03-27,-21126.5168,-7.99%,-9890.3232,-3.74%,-11236.1936,-4.25%,-2102.184,-0.79%,23228.7008,8.78%,3.77,-1.31%",
		"2019-03-28,2376.84,0.89%,18624.9696,7%,-16248.1296,-6.1%,-5517.8032,-2.07%,3140.9648,1.18%,3.79,0.53%",
		"2019-03-29,19747.4768,5.87%,21062.0864,6.26%,-1314.6096,-0.39%,-8313.472,-2.47%,-11434.0032,-3.4%,3.87,2.11%",
		"2019-04-01,16876.0064,3.87%,15992.336,3.67%,883.6704,0.2%,-4926.7088,-1.13%,-11949.2976,-2.74%,3.98,2.84%",
		"2019-04-02,-14199.4864,-4.5%,-9359.6608,-2.96%,-4839.8256,-1.53%,1377.3744,0.44%,12822.1136,4.06%,3.94,-1.01%",
		"2019-04-03,-33938.8752,-12.51%,-29768.4768,-10.97%,-4170.3984,-1.54%,8671.7184,3.2%,25267.1552,9.31%,3.94,0%",
		"2019-04-04,344.296,0.1%,11963.9088,3.65%,-11619.6128,-3.54%,-3332.9328,-1.02%,2988.6352,0.91%,3.95,0.25%",
		"2019-04-08,-82769.2832,-21.79%,-72164.4464,-19%,-10604.8368,-2.79%,18188.0896,4.79%,64581.1936,17%,3.85,-2.53%",
		"2019-04-09,-17589.7104,-9.57%,-13963.0784,-7.6%,-3626.632,-1.97%,3337.0288,1.82%,14252.6816,7.75%,3.85,0%",
		"2019-04-10,-10986.8432,-3.31%,-4349.1008,-1.31%,-6637.7424,-2%,12.6592,0%,10974.1824,3.31%,3.89,1.04%",
		"2019-04-11,-23059.3792,-10.81%,-17919.1664,-8.4%,-5140.2128,-2.41%,3861.3648,1.81%,19198.0144,9%,3.81,-2.06%",
		"2019-04-12,-17172.6099,-13.96%,-9549.8947,-7.76%,-7622.7152,-6.2%,1690.3392,1.37%,15482.2698,12.58%,3.80,-0.26%",
		"2019-04-15,-8442.1632,-4.12%,-6883.0416,-3.36%,-1559.1216,-0.76%,-2829.7536,-1.38%,11271.9168,5.5%,3.80,0%",
		"2019-04-16,6282.6432,2.62%,12435.4048,5.18%,-6152.7616,-2.56%,-6715.9952,-2.8%,433.352,0.18%,3.86,1.58%",
		"2019-04-17,20402.3424,4.03%,6040.04,1.19%,14362.3024,2.84%,-9428.3376,-1.86%,-10974.0064,-2.17%,3.96,2.59%",
		"2019-04-18,-13705.1552,-5.81%,-11102.208,-4.71%,-2602.9472,-1.1%,4605.0912,1.95%,9100.0656,3.86%,3.92,-1.01%",
		"2019-04-19,-6520.2736,-3.51%,-9364.1168,-5.04%,2843.8432,1.53%,-218.3392,-0.12%,6738.6128,3.63%,3.92,0%",
		"2019-04-22,-10329.4544,-3.71%,-14623.2864,-5.25%,4293.832,1.54%,2411.2736,0.86%,7918.1808,2.84%,3.92,0%",
		"2019-04-23,-24042.5392,-12%,-20218.656,-10.09%,-3823.8832,-1.91%,766.08,0.38%,23276.4624,11.62%,3.83,-2.30%",
		"2019-04-24,82045.9968,13.22%,83806.7312,13.5%,-1760.7344,-0.28%,-41924.0816,-6.75%,-40121.9152,-6.46%,4.05,5.74%",
		"2019-04-25,-102115.6192,-24.69%,-106261.8928,-25.7%,4146.2736,1%,34109.1888,8.25%,68006.4304,16.45%,3.84,-5.19%",
		"2019-04-26,-25837.1616,-12.22%,-15476.4096,-7.32%,-10360.752,-4.9%,3693.5664,1.75%,22143.5952,10.48%,3.79,-1.30%",
		"2019-04-29,-67627.504,-18.43%,-49443.3776,-13.47%,-18184.1264,-4.96%,9843.5344,2.68%,57783.9696,15.75%,3.54,-6.60%",
		"2019-04-30,-17649.6796,-12.15%,-17779.8588,-12.24%,130.1792,0.09%,-56.6832,-0.04%,17706.3632,12.19%,3.57,0.85%",
		"2019-05-06,-47966.1632,-16.82%,-35113.5728,-12.31%,-12852.5904,-4.51%,4013.696,1.41%,43952.4672,15.41%,3.29,-7.84%",
		"2019-05-07,-12294.3616,-7.65%,-5866.8848,-3.65%,-6427.4768,-4%,345.9808,0.22%,11948.3776,7.43%,3.35,1.82%",
		"2019-05-08,14725.7536,6.68%,20747.6928,9.41%,-6021.9392,-2.73%,-8692.2176,-3.94%,-6033.536,-2.74%,3.42,2.09%",
		"2019-05-09,-11330.8544,-8.48%,-6692.8464,-5.01%,-4638.008,-3.47%,3376.3504,2.53%,7954.5029,5.96%,3.39,-0.88%",
		"2019-05-10,-4401.5616,-2.1%,-546.1392,-0.26%,-3855.4224,-1.84%,-2672.8544,-1.28%,7074.416,3.38%,3.47,2.36%",
		"2019-05-13,-38620.2431,-26.3%,-30082.3807,-20.48%,-8537.8624,-5.81%,11793.4048,8.03%,26826.8373,18.27%,3.39,-2.31%",
		"2019-05-14,-5470.1671,-6.09%,-3765.5833,-4.2%,-1704.5838,-1.9%,-2321.8018,-2.59%,7791.9689,8.68%,3.36,-0.88%",
		"2019-05-15,-5830.3391,-5.27%,-1971.3135,-1.78%,-3859.0256,-3.49%,609.4528,0.55%,5220.8862,4.72%,3.39,0.89%",
		"2019-05-16,-8027.9225,-7.7%,-5612.3197,-5.39%,-2415.6028,-2.32%,1305.128,1.25%,6722.7926,6.45%,3.39,0%",
		"2019-05-17,-39754.7721,-25.37%,-27133.9417,-17.31%,-12620.8304,-8.05%,7388.4304,4.71%,32366.3418,20.65%,3.29,-2.95%",
		"2019-05-20,1981.1856,1.24%,6303.3888,3.94%,-4322.2032,-2.7%,-2128.6256,-1.33%,147.44,0.09%,3.36,2.13%",
		"2019-05-21,19643.2432,8.91%,20616.3632,9.35%,-973.12,-0.44%,-7653.1408,-3.47%,-11990.1024,-5.44%,3.44,2.38%",
		"2019-05-22,-3403.2416,-1.97%,-2810.2144,-1.63%,-593.0272,-0.34%,-837.4736,-0.49%,4240.7136,2.46%,3.46,0.58%",
		"2019-05-23,-23097.7867,-17.4%,-21472.6955,-16.17%,-1625.0912,-1.22%,6136.1279,4.62%,16961.6586,12.78%,3.37,-2.60%",
		"2019-05-24,-4754.8168,-6.72%,-2906.6727,-4.11%,-1848.1441,-2.61%,-1996.5563,-2.82%,6751.3731,9.54%,3.35,-0.59%",
		"2019-05-27,34446.5936,18.23%,35946.8864,19.02%,-1500.2928,-0.79%,-13222.8464,-7%,-21223.7488,-11.23%,3.49,4.18%",
		"2019-05-28,-30256.9808,-19.44%,-28464.9488,-18.29%,-1792.032,-1.15%,9582.896,6.16%,20674.0847,13.29%,3.45,-1.15%",
		"2019-05-29,-17378.2706,-16.51%,-16927.9255,-16.08%,-450.3451,-0.43%,6885.9453,6.54%,10492.3241,9.97%,3.42,-0.87%",
		"2019-05-30,3017.5968,1.56%,4050.5216,2.09%,-1032.9248,-0.53%,-3919.216,-2.02%,901.6176,0.46%,3.47,1.46%",
		"2019-05-31,-31205.6285,-27.95%,-29287.8319,-26.24%,-1917.7966,-1.72%,9945.2858,8.91%,21260.3424,19.05%,3.44,-0.86%",
		"2019-06-03,-3403.2154,-3.61%,-1439.3366,-1.53%,-1963.8788,-2.08%,-744.2712,-0.79%,4147.4869,4.4%,3.44,0%",
		"2019-06-04,-23536.4032,-20.22%,-23737.7088,-20.39%,201.3056,0.17%,5244.624,4.5%,18291.7795,15.71%,3.37,-2.03%",
		"2019-06-05,-7640.813,-9.09%,-4609.639,-5.48%,-3031.174,-3.61%,2034.08,2.42%,5606.733,6.67%,3.38,0.30%",
		"2019-06-06,-24386.003,-25.47%,-19683.7708,-20.56%,-4702.2322,-4.91%,4850.4046,5.07%,19535.5982,20.41%,3.32,-1.78%",
		"2019-06-10,11358.072,9.73%,11999.6384,10.28%,-641.5664,-0.55%,-6541.2186,-5.61%,-4816.8539,-4.13%,3.39,2.11%",
		"2019-06-11,30537.984,13.61%,35895.7264,16%,-5357.7424,-2.39%,-12119.3376,-5.4%,-18418.6448,-8.21%,3.49,2.95%",
		"2019-06-12,-16518.4134,-14.94%,-18385.6457,-16.63%,1867.2323,1.69%,6270.9778,5.67%,10247.4337,9.27%,3.45,-1.15%",
		"2019-06-13,-15965.2851,-17.82%,-14919.3619,-16.66%,-1045.9232,-1.17%,7098.8625,7.93%,8866.422,9.9%,3.44,-0.29%",
		"2019-06-14,-19543.3049,-21.66%,-18253.2008,-20.23%,-1290.1041,-1.43%,4166.0591,4.62%,15377.2472,17.04%,3.39,-1.45%",
		"2019-06-17,-10539.3123,-17.64%,-6115.1441,-10.23%,-4424.1682,-7.4%,2343.2299,3.92%,8196.0824,13.72%,3.37,-0.59%",
		"2019-06-18,-15084.8842,-23.8%,-14576.4621,-23%,-508.4221,-0.8%,4977.8314,7.85%,10107.0528,15.95%,3.35,-0.59%",
		"2019-06-19,548.9776,0.46%,-2043.2256,-1.71%,2592.2032,2.17%,-3224.1488,-2.7%,2675.1709,2.24%,3.38,0.90%",
		"2019-06-20,13669.3712,9.78%,8870.3312,6.34%,4799.04,3.43%,-3509.1632,-2.51%,-10160.2067,-7.27%,3.44,1.78%",
		"2019-06-21,12444.4624,5.84%,11907.3344,5.58%,537.128,0.25%,-4796.3072,-2.25%,-7648.1568,-3.59%,3.50,1.74%",
		"2019-06-24,-14194.5207,-15.6%,-14542.5517,-15.99%,348.031,0.38%,3622.2047,3.98%,10572.3163,11.62%,3.45,-1.43%",
		"2019-06-25,-13437.9919,-14.94%,-12544.772,-13.95%,-893.2199,-0.99%,299.578,0.33%,13138.4148,14.61%,3.41,-1.16%",
		"2019-06-26,-4294.3832,-5.15%,-2983.7335,-3.58%,-1310.6497,-1.57%,-1478.151,-1.77%,5772.5343,6.93%,3.42,0.29%",
		"2019-06-27,2101.3616,1.93%,1708.9616,1.57%,392.4,0.36%,-199.0859,-0.18%,-1902.275,-1.75%,3.46,1.17%",
		"2019-06-28,-4631.3858,-4.83%,-6352.5459,-6.62%,1721.1601,1.79%,-3938.5498,-4.1%,8569.9353,8.93%,3.44,-0.58%",
		"2019-07-01,247875.8994,58.23%,234979.5648,55.2%,12896.3346,3.03%,11839.1564,2.78%,2631.0308,0.62%,3.78,9.88%",
		"2019-07-02,-96435.6288,-15%,-111955.1072,-17.41%,15519.4784,2.41%,40119.8288,6.24%,56315.7984,8.76%,3.75,-0.79%",
		"2019-07-03,-24965.0656,-8.23%,-21951.6448,-7.24%,-3013.4208,-0.99%,5052.1392,1.67%,19912.9264,6.56%,3.70,-1.33%",
		"2019-07-04,-18904.3136,-10.44%,-17569.5232,-9.7%,-1334.7904,-0.74%,2852.792,1.58%,16051.5216,8.86%,3.64,-1.62%",
		"2019-07-05,-12086.1355,-11.01%,-13169.0475,-11.99%,1082.912,0.99%,3794.7092,3.46%,8291.4269,7.55%,3.65,0.27%",
		"2019-07-08,-32928.1952,-16.28%,-27645.5008,-13.66%,-5282.6944,-2.61%,4500.0688,2.22%,28428.1264,14.05%,3.52,-3.56%"]
	# print(response)
	# i = 0
	for result in response:
		#result = response[i]
		# result = result[0] + result[1] + result
		result = result.split(',')
		h = {}
		h['日期'] = result[0]
		h['收盘价'] = result[11]
		h['涨跌幅'] = result[12]
		h['主力净流入净额（万）'] = result[1]
		h['主力净流入净占比'] = result[2]
		h['超大单净流入净额（万）'] = result[3]
		h['超大单净流入净占比'] = result[4]
		h['大单净流入净额（万）'] = result[5]
		h['大单净流入净占比'] = result[6]
		h['中单净流入净额（万）'] = result[7]
		h['中单净流入净占比'] = result[8]
		h['小单净流入净额（万）'] = result[9]
		h['小单净流入净占比'] = result[10]
		yield h
		#print(item)



if __name__ == '__main__':
	url = 'http://ff.eastmoney.com//EM_CapitalFlowInterface/api/js?type=hff&rtntype=2&js=({data:[(x)]})&cb=var%20aff_data=&check=TMLBMSPROCR&acces_token=1942f5da9b46b069953c873404aad4b5&id=0007252&_=1562614286454'
	json = get_one_page(url)
	results = parse_page(json)
	i = 0
	for result in results:
		#print(result)
		if collection.insert_one(result):
			i = i + 1
			print('save to mongo')
			print(i)

#需要补全提取response
